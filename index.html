<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App de Imóveis - Corrigido</title>
  <style>
    /* ==================== RESET & GERAL ==================== */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    #imoveis-app input, #imoveis-app select {
      padding: 8px 10px;
      margin: 5px 0 15px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    #lista {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 30px;
      padding: 0 10px;
    }

    /* ==================== CARD ==================== */
    .card {
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      overflow: hidden;
      background: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    .card img { width: 100%; height: 350px; object-fit: cover; }
    .card-body { padding: 12px; flex: 1; display:flex; flex-direction:column; justify-content:space-between; }
    .card h3 { margin:0; font-size:16px; color:#1a1a1a; }
    .card p { margin:4px 0; color:#555; font-size:13px; }
    .card p.preco { font-weight:bold; color:#2d89ef; font-size:15px; }

    /* detalhes btn - pulsante e aumenta no hover */
    .btn-detalhes, .modal-content .btn-whatsapp {
      display:block; margin:10px auto 0 auto; background:#25D366; color:#fff; text-align:center; padding:8px 20px; border-radius:6px; font-weight:bold; text-decoration:none; cursor:pointer; font-size:14px; transition: transform 0.25s ease; animation: pulse 2s infinite;
    }
    .btn-detalhes:hover { transform: scale(1.08); }
    @keyframes pulse { 0%{ transform:scale(1);} 50%{ transform:scale(1.05);} 100%{ transform:scale(1);} }

    /* ==================== MODAL ==================== */
    .modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.7); overflow-x:hidden; opacity:0; transition: opacity .35s ease; }
    .modal.show { display:block; opacity:1; }
    .modal-content { background:#fff; padding:15px; border-radius:12px; width:95%; max-width:400px; max-height:90vh; overflow-y:auto; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(.96); box-sizing:border-box; opacity:0; transition: all .35s ease; }
    .modal.show .modal-content { transform:translate(-50%,-50%) scale(1); opacity:1; }
    @media(min-width:900px){ .modal-content{ max-width:800px; max-height:95vh; padding:25px; } }

    /* imagens do modal ajustadas */
    .modal-content img { 
      width:100%; 
      height:auto; 
      max-height:320px; 
      object-fit:contain; 
      background:#f4f4f4;
      border-radius:8px; 
      margin-bottom:10px; 
      cursor:pointer; 
      transition: transform .3s; 
    }
    .modal-content img.zoomed { transform: scale(2); cursor:move; }
    .modal-content img:hover:not(.zoomed) { transform: scale(1.03); }
    .modal-content .nav-arrow { position:absolute; top:50%; transform: translateY(-50%); font-size:22px; color:#fff; background:rgba(0,0,0,0.3); padding:4px 8px; border-radius:50%; cursor:pointer; user-select:none; z-index:5; }
    .modal-content .nav-left{ left:8px; } .modal-content .nav-right{ right:8px; }
    .miniaturas{ display:flex; justify-content:center; gap:6px; margin-top:8px; flex-wrap:wrap; }
    .miniaturas img{ width:50px; height:50px; object-fit:cover; border-radius:6px; cursor:pointer; border:2px solid transparent; transition:border .2s; }
    .miniaturas img.selected{ border-color:#2d89ef; }
    .close{ color:#aaa; position:absolute; top:8px; right:15px; font-size:24px; font-weight:bold; cursor:pointer; }
    .close:hover{ color:#000; }

    /* ==================== TABS & FILTROS ==================== */
    .tab{ display:inline-block; padding:6px 12px; cursor:pointer; border-radius:6px; background:#eee; margin-right:5px; font-weight:bold; font-size:14px; }
    .tab.active{ background:#2d89ef; color:#fff; }
    .ordenacao-select{ padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:14px; margin-bottom:10px; width:100%; box-sizing:border-box; }

    /* ==================== CARROSSEL ==================== */
    #destaques-container{ position:relative; margin-top:15px; }
    #destaques{ display:flex; gap:12px; overflow-x:auto; scroll-behavior:smooth; padding:0 40px; }
    #destaques .destaque-card{ min-width:160px; flex:0 0 auto; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.1); cursor:pointer; transition:transform .2s, box-shadow .2s; text-align:center; }
    #destaques .destaque-card:hover{ transform:translateY(-3px); box-shadow:0 6px 18px rgba(0,0,0,0.2); }
    #destaques .destaque-card img{ 
      width:100%; 
      height:auto; 
      max-height:250px; 
      object-fit:contain; 
      background:#f4f4f4;
    }
    #destaques .destaque-card p{ padding:6px; margin:0; font-size:12px; font-weight:bold; color:#2d89ef; }
    #destaques-container .destaque-left, #destaques-container .destaque-right{ position:absolute; top:50%; transform:translateY(-50%); font-size:28px; color:#fff; background:rgba(0,0,0,0.4); padding:6px 12px; border-radius:50%; cursor:pointer; z-index:10; }
    #destaques-container .destaque-left{ left:5px; } #destaques-container .destaque-right{ right:5px; }

    /* ==================== WHATSAPP FLUTUANTE ==================== */
    #whatsapp-flutuante{ position:fixed; bottom:15px; right:15px; width:60px; height:60px; z-index:9999; cursor:pointer; animation:pulse 2s infinite; }
    #whatsapp-flutuante img{ width:100%; height:100%; border-radius:50%; }

    /* ==================== RESPONSIVO ==================== */
    @media(min-width:600px){ #lista{ grid-template-columns:repeat(2,1fr); gap:16px; padding:0 20px; } }
    @media(min-width:900px){ #lista{ grid-template-columns:repeat(3,1fr); gap:20px; padding:0 30px; } }
    @media(max-width:480px){ .modal-content .nav-arrow, .card h3{ font-size:14px; } .card p, .card p.preco{ font-size:12px; } }
  </style>
</head>
<body>
  <!-- Destaques -->
  <div id="destaques-container">
    <span class="nav-arrow destaque-left">&#10094;</span>
    <div id="destaques"></div>
    <span class="nav-arrow destaque-right">&#10095;</span>
  </div>

  <!-- App -->
  <div id="imoveis-app">
    <div id="tabs-container"></div>
    <div id="filtros-container"></div>
    <div id="ordenacao-container"></div>
    <div id="lista"></div>

    <!-- Modal -->
    <div id="detalhesModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <div id="modal-body"></div>
      </div>
    </div>
  </div>

  <!-- WhatsApp fixo -->
  <a id="whatsapp-flutuante" href="https://api.whatsapp.com/send?phone=5512992468636" target="_blank" aria-label="WhatsApp">
    <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="WhatsApp" />
  </a>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR4c2-Gi7ANJkDp7exGoOw17T8Sh-5Gw7Ioi8ZgSCT4skcLLwULZuHhmUnQvw4Ke7dmG4VWuHDbRCuV/pub?gid=506124050&single=true&output=csv";
    const whatsappNumber = "5512992468636";

    class ModalImovel {
      constructor(id){
        this.modal = document.getElementById(id);
        this.body = this.modal.querySelector('#modal-body');
        this.close = this.modal.querySelector('.close');
        this.close.onclick = () => this.fechar();
        window.addEventListener('keydown', e => { if(e.key==='Escape') this.fechar(); });
        window.onclick = e => { if(e.target==this.modal) this.fechar(); };
        this.autoPlayInterval = null;
      }

      abrir(imovel){
        const imgs = (imovel.imagens||'').split(' ').filter(i=>i);
        let idxImg = 0;
        this.body.innerHTML = `
          <h2>${imovel.titulo}</h2>
          <p><b>Código:</b> ${imovel.ref||''}</p>
          <p><b>Preço:</b> R$ ${Number(imovel.preco).toLocaleString()} | <b>Cidade:</b> ${imovel.cidade} | <b>Bairro:</b> ${imovel.bairro||''} | <b>Tipo:</b> ${imovel.tipo||''} | <b>Operação:</b> ${imovel.operacao||''}</p>
          <p>${imovel.descricao||''}</p>
          <div style="position:relative; overflow:hidden;">
            <img id="main-img" src="${imgs[0]||'https://via.placeholder.com/400x250'}">
            <span class="nav-arrow nav-left">&#10094;</span>
            <span class="nav-arrow nav-right">&#10095;</span>
          </div>
          <div class="miniaturas">${imgs.map((s,i)=>`<img src="${s}" class="${i===0?'selected':''}">`).join('')}</div>
          <a class="btn-whatsapp" href="https://api.whatsapp.com/send?phone=${whatsappNumber}&text=Ol%C3%A1,%20interessei-me%20no%20im%C3%B3vel%20${encodeURIComponent(imovel.titulo)}" target="_blank">WhatsApp</a>
        `;
        const main=this.body.querySelector('#main-img');
        const mini=this.body.querySelectorAll('.miniaturas img');
        const left=this.body.querySelector('.nav-left');
        const right=this.body.querySelector('.nav-right');

        let idx=0,isZoom=false,drag=false,startX=0,startY=0,tx=0,ty=0;
        const update=i=>{ idx=(i+imgs.length)%imgs.length; main.src=imgs[idx]; mini.forEach((m,j)=>m.classList.toggle('selected',idx===j)); resetZoom(); };
        mini.forEach((m,i)=>m.onclick=()=> abrirOverlay(imgs[i]));
        left.onclick=()=>{ update(idx-1); clearInterval(this.autoPlayInterval); };
        right.onclick=()=>{ update(idx+1); clearInterval(this.autoPlayInterval); };

        main.style.transition='transform .3s ease';
        main.style.cursor='zoom-in';

        const toggleZoom=(cx,cy)=>{
          isZoom=!isZoom;
          main.classList.toggle('zoomed',isZoom);
          main.style.cursor=isZoom?'move':'zoom-in';
          if(isZoom){ clearInterval(this.autoPlayInterval); document.body.style.overflow='hidden';
            const rect=main.getBoundingClientRect();
            main.style.transformOrigin=`${((cx-rect.left)/main.clientWidth)*100}% ${((cy-rect.top)/main.clientHeight)*100}%`;
            tx=0;ty=0; main.style.transform=`scale(2) translate(0px,0px)`;
          }else{ document.body.style.overflow=''; main.style.transform='scale(1) translate(0px,0px)'; tx=0;ty=0; iniciarAutoplay(); }
        };
        const resetZoom=()=>{ isZoom=false; main.classList.remove('zoomed'); main.style.cursor='zoom-in'; main.style.transform='scale(1) translate(0px,0px)'; tx=0;ty=0; document.body.style.overflow=''; };
        main.addEventListener('click',e=>toggleZoom(e.clientX,e.clientY));
        const limit=()=>{
          if(!isZoom)return;
          const r=main.getBoundingClientRect(),p=main.parentElement.getBoundingClientRect();
          const mx=(r.width-p.width)/2,my=(r.height-p.height)/2;
          tx=Math.min(Math.max(tx,-mx),mx);
          ty=Math.min(Math.max(ty,-my),my);
        };
        main.addEventListener('mousedown',e=>{ if(isZoom){ drag=true; startX=e.clientX-tx; startY=e.clientY-ty; main.style.cursor='grabbing'; } });
        window.addEventListener('mousemove',e=>{ if(drag){ tx=e.clientX-startX; ty=e.clientY-startY; limit(); main.style.transform=`scale(2) translate(${tx}px,${ty}px)`; } });
        window.addEventListener('mouseup',e=>{ if(drag){ drag=false; main.style.cursor='move'; } });
        main.addEventListener('touchstart',e=>{ if(e.touches.length===1 && isZoom){ startX=e.touches[0].clientX-tx; startY=e.touches[0].clientY-ty; } },{passive:false});
        main.addEventListener('touchmove',e=>{ if(e.touches.length===1 && isZoom){ e.preventDefault(); tx=e.touches[0].clientX-startX; ty=e.touches[0].clientY-startY; limit(); main.style.transform=`scale(2) translate(${tx}px,${ty}px)`; } },{passive:false});

        // swipe main
        let tsX=0, teX=0;
        main.addEventListener('touchstart',e=>{ if(!isZoom){ tsX=e.touches[0].clientX; clearInterval(this.autoPlayInterval); } },{passive:true});
        main.addEventListener('touchmove',e=>{ if(!isZoom){ teX=e.touches[0].clientX; }},{passive:true});
        main.addEventListener('touchend',()=>{ if(!isZoom){ const diff=tsX-teX; if(Math.abs(diff)>30) diff>0?update(idx+1):update(idx-1); iniciarAutoplay(); }});

        const iniciarAutoplay=()=>{ clearInterval(this.autoPlayInterval); if(imgs.length>1)this.autoPlayInterval=setInterval(()=>update(idx+1),4000); };
        iniciarAutoplay();

        const abrirOverlay=(src)=>{
          clearInterval(this.autoPlayInterval);
          const overlay=document.createElement('div'); overlay.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
          const img=document.createElement('img'); img.src=src; img.style.maxWidth='90%'; img.style.maxHeight='90%'; img.style.cursor='zoom-in'; overlay.appendChild(img);
          let zo=false,dx=0,dy=0,dragging=false,sx=0,sy=0;
          img.onclick=()=>{ zo=!zo; img.style.transform=zo?'scale(2)':'scale(1)'; img.style.cursor=zo?'move':'zoom-in'; };
          img.addEventListener('mousedown',e=>{ if(zo){ dragging=true; sx=e.clientX-dx; sy=e.clientY-dy; img.style.cursor='grabbing'; } });
          window.addEventListener('mousemove',e=>{ if(dragging){ dx=e.clientX-sx; dy=e.clientY-sy; img.style.transform=`scale(2) translate(${dx}px,${dy}px)`; } });
          window.addEventListener('mouseup',()=>{ if(dragging){ dragging=false; img.style.cursor='move'; } });
          overlay.onclick=e=>{ if(e.target===overlay){ overlay.remove(); iniciarAutoplay(); } };
          document.body.appendChild(overlay);
        };

        this.modal.classList.add('show');
      }

      fechar(){ this.modal.classList.remove('show'); document.body.style.overflow=''; clearInterval(this.autoPlayInterval); }
    }

    class ListaImoveis{
      constructor(id, modal){ this.lista=document.getElementById(id); this.modal=modal; this.filteredData=[]; }
      render(dados, filtro={}, tab=""){
        const source=Array.isArray(dados)?dados:[];
        this.lista.innerHTML='';
        this.filteredData=source.filter(i=>{
          const p=Number(i.preco||0);
          if(tab && i.operacao!==tab) return false;
          if(filtro.busca && !(`${i.titulo} ${i.descricao} ${i.bairro||''} ${i.ref||''}`.toLowerCase().includes(filtro.busca.toLowerCase()))) return false;
          if(filtro.cidade && i.cidade!==filtro.cidade) return false;
          if(filtro.tipo && i.tipo!==filtro.tipo) return false;
          if(filtro.aceita_pet && i.aceita_pet!==filtro.aceita_pet) return false;
          if(filtro.cond_incluso && i.cond_incluso!==filtro.cond_incluso) return false;
          if(filtro.precoMin && p<Number(filtro.precoMin)) return false;
          if(filtro.precoMax && p>Number(filtro.precoMax)) return false;
          return true;
        });

        this.filteredData.forEach(i=>{
          const c=document.createElement('div'); c.className='card';
          const imgs=(i.imagens||'').split(' ').filter(s=>s);
          c.innerHTML=`
            <img src="${imgs[0]||'https://via.placeholder.com/400x250'}">
            <div class="card-body">
              <h3>${i.titulo||''}</h3>
              <p class="preco">R$ ${Number(i.preco||0).toLocaleString()}</p>
              <p>${i.cidade||''} | ${i.tipo||''}</p>
              <button class="btn-detalhes">Detalhes</button>
            </div>
          `;
          c.querySelector('.btn-detalhes').onclick=()=>this.modal.abrir(i);

          if(imgs.length>1){
            let idx=0;
            setInterval(()=>{ idx=(idx+1)%imgs.length; const elImg=c.querySelector('img'); if(elImg) elImg.src=imgs[idx]; },3000);
          }

          this.lista.appendChild(c);
        });
      }
    }

    Papa.parse(csvUrl, { download:true, header:true, complete: res=>{
      const allData=res.data.slice(1);
      const dados=allData.map(i=>{
        i.ref=i.ref||''; i.aceita_pet=(i.aceita_pet && ['sim','s','1'].includes(i.aceita_pet.trim().toLowerCase()))?'Sim':'Não';
        i.cond_incluso=(i.cond_incluso && ['sim','s','1'].includes(i.cond_incluso.trim().toLowerCase()))?'Sim':'Não';
        i.garagem=i.garagem||'0'; i.titulo=i.titulo||''; i.descricao=i.descricao||'';
        i.tipo=i.tipo||''; i.operacao=i.operacao||''; i.cidade=i.cidade||''; i.preco=i.preco||'0';
        i.condominio=i.condominio||'0'; i.iptu=i.iptu||'0'; i.area=i.area||'0'; i.banheiros=i.banheiros||'0'; i.quartos=i.quartos||'0';
        i.imagens=i.imagens||''; return i;
      });

      const modal=new ModalImovel('detalhesModal');
      const lista=new ListaImoveis('lista', modal);
      new FiltroImoveis('filtros-container', dados, lista);
      new TabsImoveis('tabs-container', dados, lista);
      new OrdenacaoImoveis('ordenacao-container', lista);
      new Destaques(dados);
    }});
  </script>
</body>
</html>
